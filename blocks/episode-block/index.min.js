const{registerBlockType:registerBlockType}=wp.blocks,{InspectorControls:InspectorControls,useBlockProps:useBlockProps}=wp.blockEditor,{PanelBody:PanelBody,SelectControl:SelectControl,TextControl:TextControl,Placeholder:Placeholder,Spinner:Spinner,Button:Button,RadioControl:RadioControl,ComboboxControl:ComboboxControl,__experimentalNumberControl:NumberControl}=wp.components,{useState:useState,useEffect:useEffect}=wp.element,{__:__}=wp.i18n,{dispatch:dispatch,select:select}=wp.data,sanitizeUrl=e=>{if(!e)return"";const t=(e=e.trim()).toLowerCase();return t.startsWith("http://")||t.startsWith("https://")||t.startsWith("mailto:")||e.startsWith("/")||e.startsWith("#")?e.replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""},cleanHtmlForBlocks=e=>{if(!e)return"";const t=document.createElement("div");t.innerHTML=e;const o=e=>{if(e.nodeType===Node.TEXT_NODE)return e.textContent;if(e.nodeType!==Node.ELEMENT_NODE)return"";const t=e.tagName.toLowerCase();let a="";const s=Array.from(e.childNodes).map(e=>o(e)).join("");switch(t){case"p":a=s+"\n\n";break;case"br":a="\n";break;case"strong":case"b":a="<strong>"+s+"</strong>";break;case"em":case"i":a="<em>"+s+"</em>";break;case"a":const t=e.getAttribute("href"),o=sanitizeUrl(t);a=o?'<a href="'+o+'">'+s+"</a>":s;break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":a="\n\n"+s+"\n\n";break;case"ul":case"ol":default:a=s;break;case"li":a="- "+s+"\n"}return a};let a=o(t);return a=a.replace(/\n{3,}/g,"\n\n"),a=a.trim(),a};registerBlockType("podloom/episode-player",{title:__("PodLoom Podcast Episode","podloom-podcast-player"),icon:"microphone",category:"media",attributes:{sourceType:{type:"string",default:"transistor"},episodeId:{type:"string",default:""},episodeTitle:{type:"string",default:""},showId:{type:"string",default:""},showTitle:{type:"string",default:""},showSlug:{type:"string",default:""},rssFeedId:{type:"string",default:""},rssEpisodeData:{type:"object",default:null},episodeDescription:{type:"string",default:""},embedHtml:{type:"string",default:""},theme:{type:"string",default:"light"},displayMode:{type:"string",default:"specific"},playlistHeight:{type:"number",default:390},playlistMaxEpisodes:{type:"number",default:25},playlistOrder:{type:"string",default:"episodic"}},edit:function({attributes:e,setAttributes:t,clientId:o}){const{sourceType:a,episodeId:s,episodeTitle:l,showId:r,showTitle:p,showSlug:n,rssFeedId:d,rssEpisodeData:i,episodeDescription:c,embedHtml:m,theme:u,displayMode:y,playlistHeight:_,playlistMaxEpisodes:h,playlistOrder:f}=e,[g,w]=useState([]),[b,E]=useState([]),[S,x]=useState([]),[k,T]=useState(!1),[v,D]=useState(!0),[P,C]=useState(""),[I,L]=useState(1),[H,N]=useState(!1),[R,M]=useState(!1),[B,j]=useState(null),[F,z]=useState(null),[O,U]=useState({}),$=useBlockProps();useEffect(()=>{A()},[]),useEffect(()=>{"rss"!==a||F||G()},[a]),useEffect(()=>{"rss"===a&&"latest"===y&&d&&J(d)},[a,y,d]),useEffect(()=>{"rss"===a&&"specific"===y&&i&&K(i)},[a,y,i]),useEffect(()=>{"rss"===a&&"latest"===y&&B&&K(B)},[a,y,B]),useEffect(()=>{if(!r&&!d&&podloomData.defaultShow){const e=g.find(e=>e.id===podloomData.defaultShow);if(e)return void t({sourceType:"transistor",showId:e.id,showTitle:e.attributes.title,showSlug:e.attributes.slug});const o=b.find(e=>e.id===podloomData.defaultShow);o&&t({sourceType:"rss",rssFeedId:o.id,showTitle:o.name})}},[g,b,r,d]),useEffect(()=>{if("rss"===a&&d&&b.length>0){b.find(e=>e.id===d)||(t({rssFeedId:"",showTitle:"",episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null}),C(__("The selected RSS feed has been removed. Please select a different feed.","podloom-podcast-player")))}},[b,d,a]),useEffect(()=>{"specific"===y&&("transistor"===a&&r&&!s?(L(1),x([]),W(r,1)):"rss"===a&&d&&!i&&(L(1),x([]),q(d,1)))},[r,d,a,y]);const A=async()=>{D(!0),C("");try{const e=new FormData;e.append("action","podloom_get_block_init_data"),e.append("nonce",podloomData.nonce);const t=await fetch(podloomData.ajaxUrl,{method:"POST",body:e}),o=await t.json();if(o.success){if(o.data.podloom_shows&&o.data.podloom_shows.data&&w(o.data.podloom_shows.data),o.data.rss_feeds){const e=Object.values(o.data.rss_feeds).filter(e=>e.valid);E(e)}o.data.rss_typography&&z(o.data.rss_typography)}else C(__("Error loading block data.","podloom-podcast-player"))}catch(e){C(__("Error loading block data.","podloom-podcast-player"))}finally{D(!1)}},W=async(e,t=1,o=!1)=>{o?M(!0):T(!0),C("");try{const o="20",a=new URLSearchParams({action:"podloom_get_episodes",nonce:podloomData.nonce,show_id:e,page:t.toString(),per_page:o}),s=await fetch(`${podloomData.ajaxUrl}?${a.toString()}`),l=await s.json();if(l.success){const e=l.data.data||[],t=l.data.meta||{};x(t=>[...t,...e]),N(t.currentPage<t.totalPages),L(t.currentPage)}else C(l.data.message||__("Failed to load episodes","podloom-podcast-player"))}catch(e){C(__("Error loading episodes","podloom-podcast-player"))}finally{T(!1),M(!1)}},q=async(e,t=1,o=!1)=>{o?M(!0):T(!0),C("");try{const o="20",a=new FormData;a.append("action","podloom_get_rss_episodes"),a.append("nonce",podloomData.nonce),a.append("feed_id",e),a.append("page",t.toString()),a.append("per_page",o);const s=await fetch(podloomData.ajaxUrl,{method:"POST",body:a}),l=await s.json();if(l.success){const e=(l.data.episodes||[]).map(e=>({id:e.id,type:"rss_episode",attributes:{title:e.title,status:"published",audio_url:e.audio_url,image:e.image,description:e.description,content:e.content,date:e.date,duration:e.duration}}));x(t=>[...t,...e]),N(l.data.page<l.data.pages),L(l.data.page)}else C(l.data.message||__("Failed to load RSS episodes","podloom-podcast-player"))}catch(e){C(__("Error loading RSS episodes","podloom-podcast-player"))}finally{T(!1),M(!1)}},G=async()=>{if(!F)try{const e=new FormData;e.append("action","podloom_get_rss_typography"),e.append("nonce",podloomData.nonce);const t=await fetch(podloomData.ajaxUrl,{method:"POST",body:e}),o=await t.json();o.success&&z(o.data)}catch(e){}},J=async e=>{try{const t=new FormData;t.append("action","podloom_get_rss_episodes"),t.append("nonce",podloomData.nonce),t.append("feed_id",e),t.append("page","1"),t.append("per_page","1");const o=await fetch(podloomData.ajaxUrl,{method:"POST",body:t}),a=await o.json();a.success&&a.data.episodes&&a.data.episodes.length>0&&j(a.data.episodes[0])}catch(e){}},K=async e=>{if(!e)return;const t=e.id||e.title;if(!O[t])try{const o=new FormData;o.append("action","podloom_render_rss_episode"),o.append("nonce",podloomData.nonce),o.append("episode_data",JSON.stringify(e)),o.append("feed_id",d);const a=await fetch(podloomData.ajaxUrl,{method:"POST",body:o}),s=await a.json();s.success&&s.data.html?U(e=>({...e,[t]:s.data.html})):console.warn("PodLoom: Failed to fetch rendered episode HTML",s)}catch(e){console.error("PodLoom: Error fetching rendered episode HTML",e)}},X=(e,t)=>{if(!e||!t)return null;const o=t.display||{artwork:!0,title:!0,date:!0,duration:!0,description:!0},a=[];o.artwork&&e.image&&a.push(wp.element.createElement("div",{key:"artwork-wrapper",className:"rss-episode-artwork"},[wp.element.createElement("img",{key:"artwork-img",src:e.image,alt:e.title})]));const s=[];o.title&&e.title&&s.push(wp.element.createElement("h3",{key:"title",className:"rss-episode-title"},e.title));const l=[];var r;if(o.date&&e.date&&l.push(wp.element.createElement("span",{key:"date",className:"rss-episode-date"},(r=e.date,new Date(1e3*r).toLocaleDateString()))),o.duration&&e.duration&&l.push(wp.element.createElement("span",{key:"duration",className:"rss-episode-duration"},(e=>{if(!e)return"";const t=Math.floor(e/3600),o=Math.floor(e%3600/60),a=e%60;return t>0?`${t}:${String(o).padStart(2,"0")}:${String(a).padStart(2,"0")}`:`${o}:${String(a).padStart(2,"0")}`})(e.duration))),l.length>0&&s.push(wp.element.createElement("div",{key:"meta",className:"rss-episode-meta"},l)),e.audio_url){const t=o.description&&e.description?"rss-episode-audio":"rss-episode-audio rss-audio-last",a=[wp.element.createElement("source",{key:"source",src:e.audio_url,type:e.audio_type||"audio/mpeg"}),__("Your browser does not support the audio player.","podloom-podcast-player")];s.push(wp.element.createElement("audio",{key:"audio",className:t,controls:!0,preload:"metadata"},a))}o.description&&e.description&&s.push(wp.element.createElement("div",{key:"description",className:"rss-episode-description",dangerouslySetInnerHTML:{__html:e.description}})),s.length>0&&a.push(wp.element.createElement("div",{key:"content",className:"rss-episode-content"},s));const p=wp.element.createElement("div",{key:"wrapper",className:"rss-episode-wrapper"},a);return wp.element.createElement("div",{className:"wp-block-podloom-episode-player rss-episode-player"},[p])};if(v)return wp.element.createElement("div",$,wp.element.createElement(Placeholder,{icon:"microphone",label:__("PodLoom Podcast Episode","podloom-podcast-player")},wp.element.createElement(Spinner),wp.element.createElement("p",null,__("Loading sources...","podloom-podcast-player"))));if(!podloomData.hasApiKey&&0===g.length&&0===b.length)return wp.element.createElement("div",$,wp.element.createElement(Placeholder,{icon:"microphone",label:__("PodLoom Podcast Episode","podloom-podcast-player")},wp.element.createElement("p",null,__("Please configure your Transistor API key or add RSS feeds in the settings.","podloom-podcast-player")),wp.element.createElement(Button,{variant:"primary",href:`${podloomData.ajaxUrl.replace("/wp-admin/admin-ajax.php","")}/wp-admin/admin.php?page=podloom-settings`},__("Go to Settings","podloom-podcast-player"))));const Y="transistor"===a&&n,Q="rss"===a&&d,V="transistor"===a&&n||"rss"===a&&d;return wp.element.createElement(wp.element.Fragment,null,wp.element.createElement(InspectorControls,null,wp.element.createElement(PanelBody,{title:__("Episode Settings","podloom-podcast-player"),initialOpen:!0},wp.element.createElement(SelectControl,{label:__("Select Source","podloom-podcast-player"),value:"transistor"===a&&r?`transistor:${r}`:"rss"===a&&d?`rss:${d}`:"",options:(()=>{const e=[{label:__("-- Select a source --","podloom-podcast-player"),value:""}];return g.length>0&&(e.push({label:__("━━ Transistor.fm ━━","podloom-podcast-player"),value:"__podloom_header__",disabled:!0}),g.forEach(t=>{e.push({label:"  "+t.attributes.title,value:`transistor:${t.id}`})})),b.length>0&&(e.push({label:__("━━ RSS Feeds ━━","podloom-podcast-player"),value:"__rss_header__",disabled:!0}),b.forEach(t=>{e.push({label:"  "+t.name,value:`rss:${t.id}`})})),e})(),onChange:e=>{const[o,a]=e.split(":");if("transistor"===o){const e=g.find(e=>e.id===a);t({sourceType:"transistor",showId:a,showTitle:e?e.attributes.title:"",showSlug:e?e.attributes.slug:"",rssFeedId:"",episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null})}else if("rss"===o){const e=b.find(e=>e.id===a);t({sourceType:"rss",showId:"",showTitle:"",showSlug:"",rssFeedId:a,showTitle:e?e.name:"",episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null})}x([])},help:__("Choose a Transistor show or RSS feed","podloom-podcast-player")}),(r||d)&&"specific"===y&&wp.element.createElement("div",{style:{marginTop:"16px",marginBottom:"16px"}},k&&0===S.length?wp.element.createElement("div",{style:{marginTop:"8px"}},wp.element.createElement(Spinner),wp.element.createElement("p",null,__("Loading episodes...","podloom-podcast-player"))):wp.element.createElement(ComboboxControl,{label:__("Search and Select Episode","podloom-podcast-player"),value:s,onChange:e=>{if("__load_more__"===e)return void(()=>{const e=I+1;"transistor"===a?W(r,e,!0):q(d,e,!0)})();const o=S.find(t=>t.id===e);o?(e=>{if("transistor"===a){const o="dark"===u?e.attributes.embed_html_dark:e.attributes.embed_html;t({episodeId:e.id,episodeTitle:e.attributes.title,episodeDescription:e.attributes.description||"",embedHtml:o,rssEpisodeData:null})}else t({episodeId:e.id,episodeTitle:e.attributes.title,embedHtml:"",rssEpisodeData:{title:e.attributes.title,audio_url:e.attributes.audio_url,image:e.attributes.image,description:e.attributes.description,content:e.attributes.content,date:e.attributes.date,duration:e.attributes.duration,podcast20:e.attributes.podcast20||null}})})(o):t({episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null})},options:[...S.map(e=>{const t=e.attributes.status,o="draft"===t?" (Draft)":"scheduled"===t?" (Scheduled)":"";return{label:e.attributes.title+o,value:e.id}}),...H?[{label:__(R?"Loading more episodes...":"Load More Episodes...","podloom-podcast-player"),value:"__load_more__"}]:[]],help:S.length>0?__("Type to search episodes, or scroll to browse","podloom-podcast-player"):null})),(r||d)&&wp.element.createElement(RadioControl,{label:__("Display Mode","podloom-podcast-player"),selected:y,options:[{label:__("Specific Episode","podloom-podcast-player"),value:"specific"},...V?[{label:__("Latest Episode","podloom-podcast-player"),value:"latest"}]:[],...Y||Q?[{label:__("Playlist","podloom-podcast-player"),value:"playlist"}]:[]],onChange:e=>{t({displayMode:e})},help:"latest"===y?__("Will always show the most recent episode from this source","podloom-podcast-player"):"playlist"===y&&Y?__("Displays a playlist of episodes. Episode count is controlled in your Transistor settings.","podloom-podcast-player"):"playlist"===y&&Q?__("Displays a playlist with an Episodes tab. Select episodes to play and view their details.","podloom-podcast-player"):null}),"playlist"===y&&Y&&NumberControl&&wp.element.createElement(NumberControl,{label:__("Playlist Height (px)","podloom-podcast-player"),value:_,onChange:e=>t({playlistHeight:parseInt(e)||390}),min:200,max:1e3,step:10,help:__("Adjust the height of the playlist player (200-1000px)","podloom-podcast-player")}),"playlist"===y&&Q&&NumberControl&&wp.element.createElement(NumberControl,{label:__("Max Episodes","podloom-podcast-player"),value:h,onChange:e=>t({playlistMaxEpisodes:parseInt(e)||25}),min:5,max:100,step:5,help:__("Maximum number of episodes to display in the playlist (5-100)","podloom-podcast-player")}),"playlist"===y&&Q&&wp.element.createElement(RadioControl,{label:__("Episode Order","podloom-podcast-player"),selected:f||"episodic",options:[{label:__("Episodic (newest first)","podloom-podcast-player"),value:"episodic"},{label:__("Serial (oldest first)","podloom-podcast-player"),value:"serial"}],onChange:e=>t({playlistOrder:e}),help:__("Episodic for talk shows, Serial for narrative podcasts","podloom-podcast-player")}),"transistor"===a&&r&&wp.element.createElement(RadioControl,{label:__("Player Theme","podloom-podcast-player"),selected:u,options:[{label:__("Light","podloom-podcast-player"),value:"light"},{label:__("Dark","podloom-podcast-player"),value:"dark"}],onChange:e=>{if(t({theme:e}),"transistor"===a&&s&&S.length>0){const o=S.find(e=>e.id===s);if(o){const a="dark"===e?o.attributes.embed_html_dark:o.attributes.embed_html;t({embedHtml:a})}}}}),"specific"===y&&s&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#f0f0f0",borderRadius:"4px"}},wp.element.createElement("strong",null,__("Selected Episode:","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},l),a&&wp.element.createElement("p",{style:{margin:"4px 0 0 0",fontSize:"11px",color:"#666"}},__("Source: ","podloom-podcast-player")+("transistor"===a?"Transistor.fm":"RSS Feed")),wp.element.createElement(Button,{variant:"secondary",onClick:()=>{let e="";if("rss"===a&&i&&i.description?e=i.description:"transistor"===a&&c&&(e=c),!e)return;const t=cleanHtmlForBlocks(e),s=select("core/block-editor"),l=s.getBlockIndex(o),r=s.getBlockRootClientId(o),p=t.split("\n\n").filter(e=>""!==e.trim()).map(e=>wp.blocks.createBlock("core/paragraph",{content:e.trim()}));dispatch("core/block-editor").insertBlocks(p,l+1,r)},style:{marginTop:"12px",width:"100%"}},__("Paste Description","podloom-podcast-player"))),"latest"===y&&(r||d)&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#e7f5ff",borderRadius:"4px",border:"1px solid #1e88e5"}},wp.element.createElement("strong",null,__("Latest Episode Mode","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},__("This block will always display the most recent episode from ","podloom-podcast-player")+p)),"playlist"===y&&Y&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#f3e5f5",borderRadius:"4px",border:"1px solid #9c27b0"}},wp.element.createElement("strong",null,__("Playlist Mode","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},__("This block will display a playlist from ","podloom-podcast-player")+p+__(". Episode count is controlled in your Transistor settings.","podloom-podcast-player"))),"playlist"===y&&Q&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#e8f5e9",borderRadius:"4px",border:"1px solid #4caf50"}},wp.element.createElement("strong",null,__("RSS Playlist Mode","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},__("Displays up to ","podloom-podcast-player")+h+__(" episodes from ","podloom-podcast-player")+p+__("serial"===f?" (oldest first)":" (newest first)","podloom-podcast-player")+__(". Click any episode to play it.","podloom-podcast-player"))))),wp.element.createElement("div",$,"latest"===y&&"transistor"===a&&r&&n?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:'<iframe width="100%" height="180" frameborder="no" scrolling="no" seamless src="https://share.transistor.fm/e/'+encodeURIComponent(n)+"/"+("dark"===u?"latest/dark":"latest")+'"></iframe>'}}):"playlist"===y&&"transistor"===a&&r&&n?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:'<iframe width="100%" height="'+parseInt(_||390)+'" frameborder="no" scrolling="no" seamless src="https://share.transistor.fm/e/'+encodeURIComponent(n)+"/"+("dark"===u?"playlist/dark":"playlist")+'"></iframe>'}}):"specific"===y&&"transistor"===a&&s&&m?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:m}}):"latest"===y&&"rss"===a&&d?B&&F?O[B.id||B.title]?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:O[B.id||B.title]}}):X(B,F):wp.element.createElement("div",{style:{background:"#f9f9f9",border:"1px solid #ddd",borderRadius:"8px",padding:"20px",minHeight:"180px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}},wp.element.createElement("span",{className:"dashicons dashicons-rss",style:{fontSize:"48px",color:"#f8981d",marginBottom:"10px"}}),wp.element.createElement("p",{style:{margin:"0",fontSize:"14px",color:"#666",textAlign:"center",fontWeight:"600"}},__("Loading Latest RSS Episode...","podloom-podcast-player"))):"specific"===y&&"rss"===a&&s&&i?F?O[i.id||i.title]?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:O[i.id||i.title]}}):X(i,F):wp.element.createElement("div",{style:{padding:"20px",background:"#f9f9f9",border:"1px solid #ddd",borderRadius:"8px"}},wp.element.createElement("p",{style:{margin:"0",fontSize:"14px",color:"#666"}},__("Loading episode...","podloom-podcast-player"))):"playlist"===y&&"rss"===a&&d?wp.element.createElement("div",{style:{background:"#f9f9f9",border:"1px solid #ddd",borderRadius:"8px",padding:"20px",minHeight:"200px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}},wp.element.createElement("span",{className:"dashicons dashicons-playlist-audio",style:{fontSize:"48px",color:"#4caf50",marginBottom:"10px"}}),wp.element.createElement("p",{style:{margin:"0",fontSize:"16px",color:"#333",textAlign:"center",fontWeight:"600"}},__("RSS Playlist Player","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px",color:"#666",textAlign:"center"}},__("Displays ","podloom-podcast-player")+h+__(" episodes with an Episodes tab","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"4px 0 0 0",fontSize:"12px",color:"#999",textAlign:"center"}},__("Preview available on frontend","podloom-podcast-player"))):wp.element.createElement(Placeholder,{icon:"microphone",label:__("PodLoom Podcast Episode","podloom-podcast-player")},r||d?"specific"!==y||s?wp.element.createElement("p",null,__("Please configure the block settings.","podloom-podcast-player")):wp.element.createElement("p",null,__("Please select an episode from the sidebar.","podloom-podcast-player")):wp.element.createElement("p",null,__("Please select a source from the sidebar.","podloom-podcast-player")))))},save:function(){return null}});