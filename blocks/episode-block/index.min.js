import"../store";import{STORE_NAME}from"../store/constants";const{registerBlockType:registerBlockType}=wp.blocks,{InspectorControls:InspectorControls,useBlockProps:useBlockProps}=wp.blockEditor,{PanelBody:PanelBody,SelectControl:SelectControl,Placeholder:Placeholder,Spinner:Spinner,Button:Button,RadioControl:RadioControl,ComboboxControl:ComboboxControl,__experimentalNumberControl:NumberControl}=wp.components,{useState:useState,useEffect:useEffect,useCallback:useCallback}=wp.element,{useSelect:useSelect,useDispatch:useDispatch}=wp.data,{__:__}=wp.i18n,{dispatch:wpDispatch,select:wpSelect}=wp.data,sanitizeUrl=e=>{if(!e)return"";const t=(e=e.trim()).toLowerCase();return t.startsWith("http://")||t.startsWith("https://")||t.startsWith("mailto:")||e.startsWith("/")||e.startsWith("#")?e.replace(/"/g,"&quot;").replace(/'/g,"&#39;"):""},cleanHtmlForBlocks=e=>{if(!e)return"";const t=document.createElement("div");t.innerHTML=e;const o=e=>{if(e.nodeType===Node.TEXT_NODE)return e.textContent;if(e.nodeType!==Node.ELEMENT_NODE)return"";const t=e.tagName.toLowerCase();let s="";const l=Array.from(e.childNodes).map(e=>o(e)).join("");switch(t){case"p":s=l+"\n\n";break;case"br":s="\n";break;case"strong":case"b":s="<strong>"+l+"</strong>";break;case"em":case"i":s="<em>"+l+"</em>";break;case"a":const t=e.getAttribute("href"),o=sanitizeUrl(t);s=o?'<a href="'+o+'">'+l+"</a>":l;break;case"h1":case"h2":case"h3":case"h4":case"h5":case"h6":s="\n\n"+l+"\n\n";break;case"ul":case"ol":default:s=l;break;case"li":s="- "+l+"\n"}return s};let s=o(t);return s=s.replace(/\n{3,}/g,"\n\n"),s=s.trim(),s},sanitizeHtmlForPreview=e=>{if(!e)return"";const t=document.createElement("div");t.innerHTML=e;const o=new Set(["p","br","strong","b","em","i","u","a","ul","ol","li","blockquote","code","pre"]),s=e=>{if(e.nodeType===Node.TEXT_NODE)return e.textContent;if(e.nodeType!==Node.ELEMENT_NODE)return"";const t=e.tagName.toLowerCase(),l=Array.from(e.childNodes).map(e=>s(e)).join("");if(!o.has(t))return l;if("a"===t){const t=sanitizeUrl(e.getAttribute("href"));if(!t)return l;return`<a href="${t}"${"_blank"===e.getAttribute("target")?' target="_blank" rel="noopener noreferrer"':""}>${l}</a>`}return"br"===t?"<br>":`<${t}>${l}</${t}>`};return Array.from(t.childNodes).map(e=>s(e)).join("")};registerBlockType("podloom/episode-player",{title:__("PodLoom Podcast Episode","podloom-podcast-player"),icon:"microphone",category:"media",attributes:{sourceType:{type:"string",default:"transistor"},episodeId:{type:"string",default:""},episodeTitle:{type:"string",default:""},showId:{type:"string",default:""},showTitle:{type:"string",default:""},showSlug:{type:"string",default:""},rssFeedId:{type:"string",default:""},rssEpisodeData:{type:"object",default:null},episodeDescription:{type:"string",default:""},embedHtml:{type:"string",default:""},theme:{type:"string",default:"light"},displayMode:{type:"string",default:"specific"},playlistHeight:{type:"number",default:390},playlistMaxEpisodes:{type:"number",default:25},playlistOrder:{type:"string",default:"episodic"}},edit:function({attributes:e,setAttributes:t,clientId:o}){const{sourceType:s,episodeId:l,episodeTitle:a,showId:r,showTitle:i,showSlug:p,rssFeedId:n,rssEpisodeData:d,episodeDescription:c,embedHtml:m,theme:u,displayMode:y,playlistHeight:h,playlistMaxEpisodes:_,playlistOrder:f}=e,[g,b]=useState(""),w=useBlockProps(),{transistorShows:E,rssFeeds:S,isLoaded:x,rssTypography:k,episodes:T,isEpisodesLoading:v,hasMore:C,renderedHtml:D}=useSelect(e=>{const t=e(STORE_NAME),o=t.getAllSources(),l="transistor"===s?r:n;return{transistorShows:o.transistorShows,rssFeeds:o.rssFeeds,isLoaded:o.isLoaded,rssTypography:t.getRssTypography(),episodes:l?t.getEpisodes(s,l):[],isEpisodesLoading:!!l&&t.isEpisodesLoading(s,l),hasMore:!!l&&t.hasMoreEpisodes(s,l),renderedHtml:d?t.getRenderedEpisodeHtml(d.id||d.title):null}},[s,r,n,d]),{fetchMoreEpisodes:P,fetchRenderedEpisodeHtml:I}=useDispatch(STORE_NAME);useEffect(()=>{if(!r&&!n&&window.podloomData?.defaultShow&&x){const e=E.find(e=>e.id===window.podloomData.defaultShow);if(e)return void t({sourceType:"transistor",showId:e.id,showTitle:e.attributes.title,showSlug:e.attributes.slug});const o=S.find(e=>e.id===window.podloomData.defaultShow);o&&t({sourceType:"rss",rssFeedId:o.id,showTitle:o.name})}},[E,S,r,n,x]),useEffect(()=>{if("rss"===s&&n&&S.length>0){S.find(e=>e.id===n)||(t({rssFeedId:"",showTitle:"",episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null}),b(__("The selected RSS feed has been removed. Please select a different feed.","podloom-podcast-player")))}},[S,n,s]),useEffect(()=>{"rss"===s&&"specific"===y&&d&&n&&I(d,n)},[s,y,d,n]),useEffect(()=>{if("rss"===s&&"latest"===y&&n&&T.length>0){const e=T[0];e?.attributes&&I({id:e.id,title:e.attributes.title,audio_url:e.attributes.audio_url,image:e.attributes.image,description:e.attributes.description,date:e.attributes.date,duration:e.attributes.duration},n)}},[s,y,n,T]);const N=useCallback(()=>{const e="transistor"===s?r:n;e&&P(s,e)},[s,r,n,P]),L=(e,t)=>{if(!e||!t)return null;const o=t.display||{artwork:!0,title:!0,date:!0,duration:!0,description:!0},s=sanitizeHtmlForPreview(e.description||""),l=[];o.artwork&&e.image&&l.push(wp.element.createElement("div",{key:"artwork-wrapper",className:"rss-episode-artwork"},[wp.element.createElement("img",{key:"artwork-img",src:e.image,alt:e.title})]));const a=[];o.title&&e.title&&a.push(wp.element.createElement("h3",{key:"title",className:"rss-episode-title"},e.title));const r=[];var i;if(o.date&&e.date&&r.push(wp.element.createElement("span",{key:"date",className:"rss-episode-date"},(i=e.date,new Date(1e3*i).toLocaleDateString()))),o.duration&&e.duration&&r.push(wp.element.createElement("span",{key:"duration",className:"rss-episode-duration"},(e=>{if(!e)return"";const t=Math.floor(e/3600),o=Math.floor(e%3600/60),s=e%60;return t>0?`${t}:${String(o).padStart(2,"0")}:${String(s).padStart(2,"0")}`:`${o}:${String(s).padStart(2,"0")}`})(e.duration))),r.length>0&&a.push(wp.element.createElement("div",{key:"meta",className:"rss-episode-meta"},r)),e.audio_url){const t=o.description&&s?"rss-episode-audio":"rss-episode-audio rss-audio-last",l=[wp.element.createElement("source",{key:"source",src:e.audio_url,type:e.audio_type||"audio/mpeg"}),__("Your browser does not support the audio player.","podloom-podcast-player")];a.push(wp.element.createElement("audio",{key:"audio",className:t,controls:!0,preload:"metadata"},l))}o.description&&s&&a.push(wp.element.createElement("div",{key:"description",className:"rss-episode-description",dangerouslySetInnerHTML:{__html:s}})),a.length>0&&l.push(wp.element.createElement("div",{key:"content",className:"rss-episode-content"},a));const p=wp.element.createElement("div",{key:"wrapper",className:"rss-episode-wrapper"},l);return wp.element.createElement("div",{className:"wp-block-podloom-episode-player rss-episode-player"},[p])};if(!x)return wp.element.createElement("div",w,wp.element.createElement(Placeholder,{icon:"microphone",label:__("PodLoom Podcast Episode","podloom-podcast-player")},wp.element.createElement(Spinner),wp.element.createElement("p",null,__("Loading sources...","podloom-podcast-player"))));if(!window.podloomData.hasApiKey&&0===E.length&&0===S.length)return wp.element.createElement("div",w,wp.element.createElement(Placeholder,{icon:"microphone",label:__("PodLoom Podcast Episode","podloom-podcast-player")},wp.element.createElement("p",null,__("Please configure your Transistor API key or add RSS feeds in the settings.","podloom-podcast-player")),wp.element.createElement(Button,{variant:"primary",href:`${window.podloomData.ajaxUrl.replace("/wp-admin/admin-ajax.php","")}/wp-admin/admin.php?page=podloom-settings`},__("Go to Settings","podloom-podcast-player"))));const M="transistor"===s&&p,H="rss"===s&&n,R="transistor"===s&&p||"rss"===s&&n,B=(()=>{if(0===T.length)return null;const e=T[0];return e?.attributes?{id:e.id,title:e.attributes.title,audio_url:e.attributes.audio_url,image:e.attributes.image,description:e.attributes.description,date:e.attributes.date,duration:e.attributes.duration}:null})(),A=B?B.id||B.title:null;return wp.element.createElement(wp.element.Fragment,null,wp.element.createElement(InspectorControls,null,wp.element.createElement(PanelBody,{title:__("Episode Settings","podloom-podcast-player"),initialOpen:!0},wp.element.createElement(SelectControl,{label:__("Select Source","podloom-podcast-player"),value:"transistor"===s&&r?`transistor:${r}`:"rss"===s&&n?`rss:${n}`:"",options:(()=>{const e=[{label:__("-- Select a source --","podloom-podcast-player"),value:""}];return E.length>0&&(e.push({label:__("━━ Transistor.fm ━━","podloom-podcast-player"),value:"__podloom_header__",disabled:!0}),E.forEach(t=>{e.push({label:"  "+t.attributes.title,value:`transistor:${t.id}`})})),S.length>0&&(e.push({label:__("━━ RSS Feeds ━━","podloom-podcast-player"),value:"__rss_header__",disabled:!0}),S.forEach(t=>{e.push({label:"  "+t.name,value:`rss:${t.id}`})})),e})(),onChange:e=>{const[o,s]=e.split(":");if("transistor"===o){const e=E.find(e=>e.id===s);t({sourceType:"transistor",showId:s,showTitle:e?e.attributes.title:"",showSlug:e?e.attributes.slug:"",rssFeedId:"",episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null})}else if("rss"===o){const e=S.find(e=>e.id===s);t({sourceType:"rss",showId:"",showTitle:e?e.name:"",showSlug:"",rssFeedId:s,episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null})}b("")},help:__("Choose a Transistor show or RSS feed","podloom-podcast-player")}),(r||n)&&"specific"===y&&wp.element.createElement("div",{style:{marginTop:"16px",marginBottom:"16px"}},v&&0===T.length?wp.element.createElement("div",{style:{marginTop:"8px"}},wp.element.createElement(Spinner),wp.element.createElement("p",null,__("Loading episodes...","podloom-podcast-player"))):wp.element.createElement(ComboboxControl,{label:__("Search and Select Episode","podloom-podcast-player"),value:l,onChange:e=>{if("__load_more__"===e)return void N();const o=T.find(t=>t.id===e);o?(e=>{if("transistor"===s){const o="dark"===u?e.attributes.embed_html_dark:e.attributes.embed_html;t({episodeId:e.id,episodeTitle:e.attributes.title,episodeDescription:e.attributes.description||"",embedHtml:o,rssEpisodeData:null})}else t({episodeId:e.id,episodeTitle:e.attributes.title,embedHtml:"",rssEpisodeData:{title:e.attributes.title,audio_url:e.attributes.audio_url,image:e.attributes.image,description:e.attributes.description,content:e.attributes.content,date:e.attributes.date,duration:e.attributes.duration,podcast20:e.attributes.podcast20||null}})})(o):t({episodeId:"",episodeTitle:"",episodeDescription:"",embedHtml:"",rssEpisodeData:null})},options:[...T.map(e=>{const t=e.attributes.status,o="draft"===t?" (Draft)":"scheduled"===t?" (Scheduled)":"";return{label:e.attributes.title+o,value:e.id}}),...C?[{label:__(v?"Loading more episodes...":"Load More Episodes...","podloom-podcast-player"),value:"__load_more__"}]:[]],help:T.length>0?__("Type to search episodes, or scroll to browse","podloom-podcast-player"):null})),(r||n)&&wp.element.createElement(RadioControl,{label:__("Display Mode","podloom-podcast-player"),selected:y,options:[{label:__("Specific Episode","podloom-podcast-player"),value:"specific"},...R?[{label:__("Latest Episode","podloom-podcast-player"),value:"latest"}]:[],...M||H?[{label:__("Playlist","podloom-podcast-player"),value:"playlist"}]:[]],onChange:e=>{t({displayMode:e})},help:"latest"===y?__("Will always show the most recent episode from this source","podloom-podcast-player"):"playlist"===y&&M?__("Displays a playlist of episodes. Episode count is controlled in your Transistor settings.","podloom-podcast-player"):"playlist"===y&&H?__("Displays a playlist with an Episodes tab. Select episodes to play and view their details.","podloom-podcast-player"):null}),"playlist"===y&&M&&NumberControl&&wp.element.createElement(NumberControl,{label:__("Playlist Height (px)","podloom-podcast-player"),value:h,onChange:e=>t({playlistHeight:parseInt(e)||390}),min:200,max:1e3,step:10,help:__("Adjust the height of the playlist player (200-1000px)","podloom-podcast-player")}),"playlist"===y&&H&&NumberControl&&wp.element.createElement(NumberControl,{label:__("Max Episodes","podloom-podcast-player"),value:_,onChange:e=>t({playlistMaxEpisodes:parseInt(e)||25}),min:5,max:100,step:5,help:__("Maximum number of episodes to display in the playlist (5-100)","podloom-podcast-player")}),"playlist"===y&&H&&wp.element.createElement(RadioControl,{label:__("Episode Order","podloom-podcast-player"),selected:f||"episodic",options:[{label:__("Episodic (newest first)","podloom-podcast-player"),value:"episodic"},{label:__("Serial (oldest first)","podloom-podcast-player"),value:"serial"}],onChange:e=>t({playlistOrder:e}),help:__("Episodic for talk shows, Serial for narrative podcasts","podloom-podcast-player")}),"transistor"===s&&r&&wp.element.createElement(RadioControl,{label:__("Player Theme","podloom-podcast-player"),selected:u,options:[{label:__("Light","podloom-podcast-player"),value:"light"},{label:__("Dark","podloom-podcast-player"),value:"dark"}],onChange:e=>{if(t({theme:e}),"transistor"===s&&l&&T.length>0){const o=T.find(e=>e.id===l);if(o){const s="dark"===e?o.attributes.embed_html_dark:o.attributes.embed_html;t({embedHtml:s})}}}}),"specific"===y&&l&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#f0f0f0",borderRadius:"4px"}},wp.element.createElement("strong",null,__("Selected Episode:","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},a),s&&wp.element.createElement("p",{style:{margin:"4px 0 0 0",fontSize:"11px",color:"#666"}},__("Source: ","podloom-podcast-player")+("transistor"===s?"Transistor.fm":"RSS Feed")),wp.element.createElement(Button,{variant:"secondary",onClick:()=>{let e="";if("rss"===s&&d&&d.description?e=d.description:"transistor"===s&&c&&(e=c),!e)return;const t=cleanHtmlForBlocks(e),l=wpSelect("core/block-editor"),a=l.getBlockIndex(o),r=l.getBlockRootClientId(o),i=t.split("\n\n").filter(e=>""!==e.trim()).map(e=>wp.blocks.createBlock("core/paragraph",{content:e.trim()}));wpDispatch("core/block-editor").insertBlocks(i,a+1,r)},style:{marginTop:"12px",width:"100%"}},__("Paste Description","podloom-podcast-player"))),"latest"===y&&(r||n)&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#e7f5ff",borderRadius:"4px",border:"1px solid #1e88e5"}},wp.element.createElement("strong",null,__("Latest Episode Mode","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},__("This block will always display the most recent episode from ","podloom-podcast-player")+i)),"playlist"===y&&M&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#f3e5f5",borderRadius:"4px",border:"1px solid #9c27b0"}},wp.element.createElement("strong",null,__("Playlist Mode","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},__("This block will display a playlist from ","podloom-podcast-player")+i+__(". Episode count is controlled in your Transistor settings.","podloom-podcast-player"))),"playlist"===y&&H&&wp.element.createElement("div",{style:{marginTop:"16px",padding:"12px",background:"#e8f5e9",borderRadius:"4px",border:"1px solid #4caf50"}},wp.element.createElement("strong",null,__("RSS Playlist Mode","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px"}},__("Displays up to ","podloom-podcast-player")+_+__(" episodes from ","podloom-podcast-player")+i+__("serial"===f?" (oldest first)":" (newest first)","podloom-podcast-player")+__(". Click any episode to play it.","podloom-podcast-player"))))),wp.element.createElement("div",w,"latest"===y&&"transistor"===s&&r&&p?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:'<iframe width="100%" height="180" frameborder="no" scrolling="no" seamless src="https://share.transistor.fm/e/'+encodeURIComponent(p)+"/"+("dark"===u?"latest/dark":"latest")+'" title="'+(i?i.replace(/"/g,"&quot;")+" - ":"")+'Latest Episode Player"></iframe>'}}):"playlist"===y&&"transistor"===s&&r&&p?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:'<iframe width="100%" height="'+parseInt(h||390)+'" frameborder="no" scrolling="no" seamless src="https://share.transistor.fm/e/'+encodeURIComponent(p)+"/"+("dark"===u?"playlist/dark":"playlist")+'" title="'+(i?i.replace(/"/g,"&quot;")+" - ":"")+'Podcast Playlist Player"></iframe>'}}):"specific"===y&&"transistor"===s&&l&&m?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:m}}):"latest"===y&&"rss"===s&&n?B&&k?wpSelect(STORE_NAME).getRenderedEpisodeHtml(A)?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:wpSelect(STORE_NAME).getRenderedEpisodeHtml(A)}}):L(B,k):wp.element.createElement("div",{style:{background:"#f9f9f9",border:"1px solid #ddd",borderRadius:"8px",padding:"20px",minHeight:"180px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}},wp.element.createElement("span",{className:"dashicons dashicons-rss",style:{fontSize:"48px",color:"#f8981d",marginBottom:"10px"}}),wp.element.createElement("p",{style:{margin:"0",fontSize:"14px",color:"#666",textAlign:"center",fontWeight:"600"}},__("Loading Latest RSS Episode...","podloom-podcast-player"))):"specific"===y&&"rss"===s&&l&&d?k?D?wp.element.createElement("div",{dangerouslySetInnerHTML:{__html:D}}):L(d,k):wp.element.createElement("div",{style:{padding:"20px",background:"#f9f9f9",border:"1px solid #ddd",borderRadius:"8px"}},wp.element.createElement("p",{style:{margin:"0",fontSize:"14px",color:"#666"}},__("Loading episode...","podloom-podcast-player"))):"playlist"===y&&"rss"===s&&n?wp.element.createElement("div",{style:{background:"#f9f9f9",border:"1px solid #ddd",borderRadius:"8px",padding:"20px",minHeight:"200px",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center"}},wp.element.createElement("span",{className:"dashicons dashicons-playlist-audio",style:{fontSize:"48px",color:"#4caf50",marginBottom:"10px"}}),wp.element.createElement("p",{style:{margin:"0",fontSize:"16px",color:"#333",textAlign:"center",fontWeight:"600"}},__("RSS Playlist Player","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"8px 0 0 0",fontSize:"13px",color:"#666",textAlign:"center"}},__("Displays ","podloom-podcast-player")+_+__(" episodes with an Episodes tab","podloom-podcast-player")),wp.element.createElement("p",{style:{margin:"4px 0 0 0",fontSize:"12px",color:"#999",textAlign:"center"}},__("Preview available on frontend","podloom-podcast-player"))):wp.element.createElement(Placeholder,{icon:"microphone",label:__("PodLoom Podcast Episode","podloom-podcast-player")},r||n?"specific"!==y||l?wp.element.createElement("p",null,__("Please configure the block settings.","podloom-podcast-player")):wp.element.createElement("p",null,__("Please select an episode from the sidebar.","podloom-podcast-player")):wp.element.createElement("p",null,__("Please select a source from the sidebar.","podloom-podcast-player")))))},save:function(){return null}});